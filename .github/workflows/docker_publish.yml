name: Build and Push Overleaf Docker Image

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout your repo (overleaf-server)
        uses: actions/checkout@v4

      - name: Clone official overleaf repo (para Dockerfile)
        run: git clone https://github.com/overleaf/overleaf.git

      - name: Set up QEMU for ARM builds
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build sharelatex-base image locally
        run: |
          docker buildx build \
            --platform linux/arm64 \
            --tag sharelatex-base:arm64 \
            --load \
            -f overleaf/server-ce/Dockerfile-base \
            overleaf/server-ce

      - name: Modify Dockerfile to add Spanish language packages
        run: |
          cd overleaf/server-ce
          sed -i 's|^ARG OVERLEAF_BASE_TAG=.*|ARG OVERLEAF_BASE_TAG=sharelatex-base:arm64|' Dockerfile
          awk '/^EXPOSE/ {
              print;
              print "# Paquetes adicionales para soporte en español";
              print "RUN apt-get update && apt-get install -y hunspell-es && \\";
              print "    tlmgr update --self && \\";
              print "    tlmgr install babel-spanish hyphen-spanish collection-langspanish newunicodechar float jknapltx tools collection-mathscience mathtools amsmath amsfonts enumitem cancel microtype tcolorbox && \\";
              print "    tlmgr update --all && \\";
              print "    apt-get clean && \\";
              print "    rm -rf /var/lib/apt/lists/*";
              next
          }1' Dockerfile > Dockerfile.tmp && mv Dockerfile.tmp Dockerfile

      - name: Clone official overleaf-toolkit repo (para versión)
        run: git clone https://github.com/overleaf/toolkit.git

      - name: Read version file
        id: get_version
        run: echo "VERSION=$(cat toolkit/lib/config-seed/version)" >> $GITHUB_ENV

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Overleaf Docker image
        run: |
          docker buildx build \
            --platform linux/arm64 \
            --push \
            --tag pibsas/sharelatex:${{ env.VERSION }} \
            -f overleaf/server-ce/Dockerfile \
            overleaf
